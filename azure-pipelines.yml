trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: SonarCloudSecrets             # ğŸ”’ Solo contiene SONAR_TOKEN

  - name: dockerImageName
    value: 'ci-node-app'
  - name: dockerTag
    value: 'ci-$(Build.BuildId)'

steps:
  # âœ… Mostrar rama actual
  - script: |
      echo "âœ… Ejecutando en rama: $(Build.SourceBranch)"
    displayName: 'Mostrar rama actual'

  # ğŸ” DiagnÃ³stico inicial
  - script: |
      echo "ğŸ” Verificando entorno"
      docker --version
      node --version
      npm --version
    displayName: 'DiagnÃ³stico inicial'

  # ğŸŸ¦ Instalar Sonar Scanner
  - script: |
      npm install -g sonar-scanner
    displayName: 'ğŸŸ¦ Instalar sonar-scanner'

  # ğŸŸ¦ Ejecutar anÃ¡lisis SonarCloud (mezcla de pipeline + library)
  - script: |
      sonar-scanner \
        -Dsonar.projectKey=$(SONAR_PROJECT_KEY) \
        -Dsonar.organization=$(SONAR_ORGANIZATION) \
        -Dsonar.host.url=https://sonarcloud.io \
        -Dsonar.sources=. \
        -Dsonar.exclusions=node_modules/**,**/*.test.js,**/__tests__/** \
        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
        -Dsonar.login="${SONAR_TOKEN}"
    displayName: 'ğŸŸ¦ AnÃ¡lisis de calidad SonarCloud'
    env:
      SONAR_TOKEN: $(SONAR_TOKEN)

  # ğŸ³ Construir imagen Docker
  - task: Docker@2
    displayName: 'ğŸ³ Build imagen Docker'
    inputs:
      command: 'build'
      repository: '$(dockerImageName)'
      dockerfile: '**/Dockerfile'
      tags: |
        $(dockerTag)

  # ğŸ§ª Ejecutar pruebas dentro del contenedor
  - script: |
      docker run --rm $(dockerImageName):$(dockerTag) npm test
    displayName: 'ğŸ§ª Ejecutar pruebas en contenedor'

  # ğŸ“ˆ Publicar cobertura (opcional si se genera accesible fuera)
  - task: PublishCodeCoverageResults@2
    condition: succeededOrFailed()
    displayName: 'ğŸ“ˆ Publicar cobertura (si aplica)'
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: 'coverage/cobertura-coverage.xml'

  # ğŸ“„ Mostrar logs si falla
  - script: |
      docker ps -a
      docker logs $(docker ps -aqf "ancestor=$(dockerImageName):$(dockerTag)" || true)
    displayName: 'ğŸ“„ Mostrar logs del contenedor'
    condition: failed()
